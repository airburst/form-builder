<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>Care Cap</title>
        <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css"/>
        <link rel="stylesheet" href="css/jquery-ui.min.css"/>
        <link rel="stylesheet" href="assets/datepicker/css/datepicker.css"/>
        <link rel="stylesheet" href="css/spinners.css"/>
        <link rel="stylesheet" href="css/style.css" media="screen"/>
        <link rel="stylesheet" href="css/print.css" media="print"/>
        <style>
            .container { width: 100% !important; }
            #loan-table { font-size: 0.8em; }
            .table-responsive { width: 100%; overflow-y: hidden; overflow-x: scroll; -ms-overflow-style: -ms-autohiding-scrollbar; -webkit-overflow-scrolling: touch; }
        </style>
        <!--[if lt IE 9]>
        <link rel="stylesheet" type="text/css" href="css/ie8.css"/>
        <script src="js/libs/html5shiv.min.js"></script>
        <script src="js/libs/respond.min.js"></script>
        <![endif]-->
    </head>
    <body class="fb-body">
        <div class="fb-wrapper" id="fb-main">
            <form role="form" class="form-horizontal form-fb" name="Care Cap">
                <div class="container container-form">
                    <section class="page" id="p1" data-id="1" name="Care">
                        <div class="col-md-12 fb-form">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group" id="11" data-id="11">
                                        <label class="col-sm-4 control-label" for="carehometype">Care home type *</label>
                                        <div class="col-sm-4">
                                            <label class="radio-inline" for="carehometype-0">
                                                <input type="radio" name="carehometype" id="carehometype-0" value="Care Home With Nursing" tabindex="1" required="required" data-parsley-group="p1" data-parsley-errors-container=".error-container-carehometype"/>With Nursing
                                            </label>
                                            <label class="radio-inline" for="carehometype-1">
                                                <input type="radio" name="carehometype" id="carehometype-1" value="Care Home Without Nursing" tabindex="1"/>Without Nursing
                                            </label>
                                            <div class="error-container-carehometype"></div>
                                        </div>
                                    </div>
                                    <div class="form-group" id="7" data-id="7">
                                        <label class="col-sm-4 control-label" for="caretype">Care type *</label>
                                        <div class="col-sm-4">
                                            <select class="form-control" id="caretype" name="caretype" tabindex="3" data-parsley-required="true" data-parsley-group="p1">
                                                <option value=""></option>
                                                <option value="Residential">Residential</option>
                                                <option value="Residential dementia">Residential dementia</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group" id="8" data-id="8">
                                        <label class="col-sm-4 control-label" for="location">Location *</label>
                                        <div class="col-sm-4">
                                            <select class="form-control" id="location" name="location" tabindex="4" data-parsley-required="true" data-parsley-group="p1">
                                                <option value=""></option>
                                                <option value="East Midlands">East Midlands</option>
                                                <option value="East of England">East of England</option>
                                                <option value="North East England">North East England</option>
                                                <option value="North West England">North West England</option>
                                                <option value="South East England">South East England</option>
                                                <option value="London">London</option>
                                                <option value="South West England">South West England</option>
                                                <option value="West Midlands">West Midlands</option>
                                                <option value="Yorkshire and Humber">Yorkshire and Humber</option>
                                                <option value="Mid Wales">Mid Wales</option>
                                                <option value="North Wales">North Wales</option>
                                                <option value="South East Wales">South East Wales</option>
                                                <option value="South Wales">South Wales</option>
                                                <option value="West Wales">West Wales</option>
                                                <option value="Mid East Scotland">Mid East Scotland</option>
                                                <option value="Mid Scotland">Mid Scotland</option>
                                                <option value="Mid West Scotland">Mid West Scotland</option>
                                                <option value="North Scotland">North Scotland</option>
                                                <option value="South Scotland">South Scotland</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group" id="9" data-id="9">
                                        <label for="carecost" class="col-sm-4 control-label">Cost of care</label>
                                        <div class="col-sm-3">
                                            <div class="input-group">
                                                <span class="input-group-addon">£</span>
                                                <input id="carecost" name="carecost" type="text" class="form-control" tabindex="6" data-parsley-type="number" data-parsley-group="p1" data-parsley-errors-container=".error-container-carecost"/>
                                            </div>
                                            <div class="error-container-carecost"></div>
                                        </div>
                                    </div>
                                    <div class="form-group" id="10" data-id="10">
                                        <label for="nhsnursing" class="col-sm-4 control-label">NHS nursing cost</label>
                                        <div class="col-sm-3">
                                            <div class="input-group">
                                                <span class="input-group-addon">£</span>
                                                <input id="nhsnursing" name="nhsnursing" type="text" class="form-control" tabindex="7"/>
                                            </div>
                                            <div class="error-container-nhsnursing"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group" id="18" data-id="18">
                                        <label for="capital" class="col-sm-4 control-label">Savings</label>
                                        <div class="col-sm-3">
                                            <div class="input-group">
                                                <span class="input-group-addon">£</span>
                                                <input id="capital" name="capital" type="text" class="form-control" tabindex="10" data-parsley-type="number" data-parsley-group="p1" data-parsley-errors-container=".error-container-capital"/>
                                            </div>
                                            <div class="error-container-capital"></div>
                                        </div>
                                    </div>
                                    <div class="form-group" id="19" data-id="19">
                                        <label for="property" class="col-sm-4 control-label">Property value</label>
                                        <div class="col-sm-3">
                                            <div class="input-group">
                                                <span class="input-group-addon">£</span>
                                                <input id="property" name="property" type="text" class="form-control" tabindex="7" data-parsley-type="number" data-parsley-group="p1" data-parsley-errors-container=".error-container-property"/>
                                            </div>
                                            <div class="error-container-property"></div>
                                        </div>
                                    </div>
                                    <div class="form-group" id="14" data-id="14">
                                        <label for="pension" class="col-sm-4 control-label">Pension</label>
                                        <div class="col-sm-3">
                                            <div class="input-group">
                                                <span class="input-group-addon">£</span>
                                                <input id="pension" name="pension" type="text" class="form-control" tabindex="8" data-parsley-type="number" data-parsley-group="p1" data-parsley-errors-container=".error-container-pension"/>
                                            </div>
                                            <div class="error-container-pension"></div>
                                        </div>
                                    </div>
                                    <div class="form-group" id="15" data-id="15">
                                        <label for="benefits" class="col-sm-4 control-label">Benefits</label>
                                        <div class="col-sm-3">
                                            <div class="input-group">
                                                <span class="input-group-addon">£</span>
                                                <input id="benefits" name="benefits" type="text" class="form-control" tabindex="9" data-parsley-type="number" data-parsley-group="p1" data-parsley-errors-container=".error-container-benefits"/>
                                            </div>
                                            <div class="error-container-benefits"></div>
                                        </div>
                                    </div>
                                    <div class="form-group" id="16" data-id="16">
                                        <label for="other" class="col-sm-4 control-label">Other income</label>
                                        <div class="col-sm-3">
                                            <div class="input-group">
                                                <span class="input-group-addon">£</span>
                                                <input id="other" name="other" type="text" class="form-control" tabindex="9" data-parsley-type="number" data-parsley-group="p1" data-parsley-errors-container=".error-container-other"/>
                                            </div>
                                            <div class="error-container-other"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row nav-buttons">
                                <label class="col-sm-4 control-label"></label>
                                <div class="col-sm-8">
                                    <button class="btn btn-danger btn-next" onclick="if ($('.form-fb').parsley(FBRun.parsleyOptions).validate('p1') === true) {calculateCap(); FBRun.nav.moveTo('p2');}">Next</button>&nbsp;&nbsp;
                                </div>
                            </div>
                        </div>
                    </section>
                    <section class="page hide" id="p2" data-id="20" name="Cap Information">
                        <div class="col-md-12 fb-form">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group" id="25" data-id="25">
                                        <div class="alert alert-info alert-dismissable">
                                            <a class="close" href="#" data-dismiss="alert" aria-hidden="true">&times;</a>
                                            <div>
                                                <p>All figures below are weekly unless otherwise stated and based upon a care cap of £72, 000 this financial year.
                                                    <br/>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group" id="24" data-id="24">
                                        <label for="carefee" class="col-sm-4 control-label">You have quoted a care fee of </label>
                                        <div class="col-sm-3">
                                            <div class="input-group">
                                                <span class="input-group-addon">£</span>
                                                <input id="carefee" name="carefee" type="text" class="form-control" tabindex="11" data-parsley-type="number" data-parsley-group="p2" data-parsley-errors-container=".error-container-carefee"/>
                                            </div>
                                            <div class="error-container-carefee"></div>
                                        </div>
                                    </div>
                                    <div class="form-group" id="26" data-id="26">
                                        <label for="laup" class="col-sm-4 control-label">Local Authority Usual Price for this location</label>
                                        <div class="col-sm-3">
                                            <div class="input-group">
                                                <span class="input-group-addon">£</span>
                                                <input id="laup" name="laup" type="text" class="form-control" tabindex="12" data-parsley-type="number" data-parsley-group="p2" data-parsley-errors-container=".error-container-laup"/>
                                            </div>
                                            <div class="error-container-laup"></div>
                                        </div>
                                        <div>
                                            <span class="has-popover">
                                                <span class="helptext" data-container="body" data-toggle="popover" data-placement="top" data-content="The rate depends on the type of care required, e.g residential or residential with nursing" data-trigger="hover" data-original-title="">(A)</span>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="form-group" id="27" data-id="27">
                                        <label for="livingcosts" class="col-sm-4 control-label">General living costs</label>
                                        <div class="col-sm-3">
                                            <div class="input-group">
                                                <span class="input-group-addon">£</span>
                                                <input id="livingcosts" name="livingcosts" type="text" class="form-control" tabindex="13" data-parsley-type="number" data-parsley-group="p2" data-parsley-errors-container=".error-container-livingcosts"/>
                                            </div>
                                            <div class="error-container-livingcosts"></div>
                                        </div>
                                        <div>
                                            <span class="has-popover">
                                                <span class="helptext" data-container="body" data-toggle="popover" data-placement="top" data-content="Residents are required to to pay a contribution towards their general living costs (food, accommodation, energy etc.). " data-trigger="hover" data-original-title="">(B)</span>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="form-group" id="28" data-id="28">
                                        <label for="carecap" class="col-sm-4 control-label">Weekly cost to reach the point where expenditure on care is capped</label>
                                        <div class="col-sm-3">
                                            <div class="input-group">
                                                <span class="input-group-addon">£</span>
                                                <input id="carecap" name="carecap" type="text" class="form-control" tabindex="14" data-parsley-type="number" data-parsley-group="p2" data-parsley-errors-container=".error-container-carecap"/>
                                            </div>
                                            <div class="error-container-carecap"></div>
                                        </div>
                                        <div>
                                            <span class="has-popover">
                                                <span class="helptext" data-container="body" data-toggle="popover" data-placement="top" data-content="Weekly cost to reach the point where expenditure on care is capped" data-trigger="hover" data-original-title="">(A-B)</span>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="form-group" id="30" data-id="30">
                                        <label for="datecap" class="col-sm-4 control-label">Date on which cap is reached</label>
                                        <div class="col-sm-3">
                                            <input class="form-control input-md" id="datecap" name="datecap" type="text" tabindex="15"/>
                                        </div>
                                    </div>
                                    <div class="form-group" id="31" data-id="31">
                                        <label for="totalcarefee" class="col-sm-4 control-label">Cost of care before cap is reached</label>
                                        <div class="col-sm-3">
                                            <div class="input-group">
                                                <span class="input-group-addon">£</span>
                                                <input id="totalcarefee" name="totalcarefee" type="text" class="form-control" tabindex="16" data-parsley-type="number" data-parsley-group="p2" data-parsley-errors-container=".error-container-totalcarefee"/>
                                            </div>
                                            <div class="error-container-totalcarefee"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="table-responsive" id="output-table" data-id="29">
                                        <h3>Care Cap Schedule</h3>
                                        <table id="loan-table" class="table table-bordered table-striped">
                                            <thead>
                                                <tr>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="row nav-buttons">
                                <label class="col-sm-4 control-label"></label>
                                <div class="col-sm-8">
                                    <button class="btn btn-default btn-back" onclick="FBRun.nav.moveBack('p2');">Back</button>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </form>
        </div>
        <div class="spinner-container"></div>
        <script src="js/libs/jquery-1.11.1.min.js"></script>
        <script src="js/libs/jquery-ui.min.js"></script>
        <script src="assets/bootstrap/js/bootstrap.min.js"></script>
        <script src="assets/datepicker/js/bootstrap-datepicker.js"></script>
        <script src="js/libs/bootbox.js"></script>
        <script src="js/libs/parsley.js"></script>
        <script src="js/formbuilder.min.21473506.js?mode=bootstrap3"></script>
        <script>$('button, .nav-pills a').click(function(e){e.preventDefault();e.stopPropagation();}); FBRun.dates.applyDatePickers(); $('.helptext').popover(); </script>
        <script>var vis = {"rules":[],"triggers":[]}; FBRun.vis.init();</script>
        <script>        // Declare namespaces
        var DP = DP || {};

        // Define DP function
        DP = (function () {
            "use strict";

            // Example input data; would be fetched from web service
            var data = [
                {
                    dateEntered: "20/11/2013",
                    enteredBy: "Chris Parsons",
                    ref: "100",
                    finYear: "2013/14",
                    homeType: "Care Home Without Nursing",
                    careType: "Residential",
                    location: "East Midlands",
                    careFee: "600",
                    nhsNursingFee: "119.96",
                    statePension: "57.92",
                    otherBenefits: "0",
                    otherIncome: "0",
                    capitalAmount: "10000",
                    propertyValue: "170000"
                },
                {
                    dateEntered: "26/09/2013",
                    enteredBy: "Chris Parsons",
                    ref: "101",
                    finYear: "2013/14",
                    homeType: "Care Home With Nursing",
                    careType: "Residential dementia",
                    location: "East Midlands",
                    careFee: "600",
                    nhsNursingFee: "119.96",
                    statePension: "57.92",
                    otherBenefits: "60",
                    otherIncome: "80.93",
                    capitalAmount: "10000",
                    propertyValue: "170000"
                },
                {
                    dateEntered: "01/09/2014",
                    enteredBy: "Chris Parsons",
                    ref: "102",
                    finYear: "2014/15",
                    homeType: "Care Home Without Nursing",
                    careType: "Residential",
                    location: "East Midlands",
                    careFee: "625",
                    nhsNursingFee: "0",
                    statePension: "100",
                    otherBenefits: "40",
                    otherIncome: "138",
                    capitalAmount: "10000",
                    propertyValue: "109000"
                }
            ];


            // Lookup data
            var lookups = {
                careHomeData: [
                    {"homeType":"Care Home Without Nursing","careType":"Residential","location":"East Midlands","price":544.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential","location":"East of England","price":502.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential","location":"North East England","price":471.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential","location":"North West England","price":419.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential","location":"South East England","price":482.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential","location":"London","price":555.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential","location":"South West England","price":478.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential","location":"West Midlands","price":412.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential","location":"Yorkshire and Humber","price":419.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential","location":"Mid Wales","price":441.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential","location":"North Wales","price":441.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential","location":"South East Wales","price":441.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential","location":"South Wales","price":441.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential","location":"West Wales","price":441.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential","location":"Mid East Scotland","price":498.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential","location":"Mid Scotland","price":498.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential","location":"Mid West Scotland","price":498.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential","location":"North Scotland","price":498.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential","location":"South Scotland","price":498.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential","location":"East Midlands","price":585.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential","location":"East of England","price":643.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential","location":"North East England","price":581.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential","location":"North West England","price":568.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential","location":"South East England","price":741.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential","location":"London","price":696.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential","location":"South West England","price":680.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential","location":"West Midlands","price":570.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential","location":"Yorkshire and Humber","price":556.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential","location":"Mid Wales","price":564.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential","location":"North Wales","price":564.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential","location":"South East Wales","price":564.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential","location":"South Wales","price":564.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential","location":"West Wales","price":564.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential","location":"Mid East Scotland","price":594.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential","location":"Mid Scotland","price":594.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential","location":"Mid West Scotland","price":594.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential","location":"North Scotland","price":594.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential","location":"South Scotland","price":594.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential dementia","location":"East Midlands","price":461.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential dementia","location":"East of England","price":533.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential dementia","location":"North East England","price":500.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential dementia","location":"North West England","price":445.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential dementia","location":"South East England","price":511.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential dementia","location":"London","price":589.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential dementia","location":"South West England","price":507.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential dementia","location":"West Midlands","price":437.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential dementia","location":"Yorkshire and Humber","price":445.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential dementia","location":"Mid Wales","price":454.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential dementia","location":"North Wales","price":454.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential dementia","location":"South East Wales","price":454.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential dementia","location":"South Wales","price":454.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential dementia","location":"West Wales","price":454.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential dementia","location":"Mid East Scotland","price":513.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential dementia","location":"Mid Scotland","price":513.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential dementia","location":"Mid West Scotland","price":513.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential dementia","location":"North Scotland","price":513.00},
                    {"homeType":"Care Home Without Nursing","careType":"Residential dementia","location":"South Scotland","price":513.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential dementia","location":"East Midlands","price":621.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential dementia","location":"East of England","price":682.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential dementia","location":"North East England","price":616.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential dementia","location":"North West England","price":603.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential dementia","location":"South East England","price":786.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential dementia","location":"London","price":739.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential dementia","location":"South West England","price":721.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential dementia","location":"West Midlands","price":605.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential dementia","location":"Yorkshire and Humber","price":590.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential dementia","location":"Mid Wales","price":581.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential dementia","location":"North Wales","price":581.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential dementia","location":"South East Wales","price":581.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential dementia","location":"South Wales","price":581.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential dementia","location":"West Wales","price":581.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential dementia","location":"Mid East Scotland","price":612.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential dementia","location":"Mid Scotland","price":612.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential dementia","location":"Mid West Scotland","price":612.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential dementia","location":"North Scotland","price":612.00},
                    {"homeType":"Care Home With Nursing","careType":"Residential dementia","location":"South Scotland","price":612.00}
                ],
                livingCostContribution: [
                    {"location":"East Midlands","value":230.14},
                    {"location":"East of England","value":230.14},
                    {"location":"North East England","value":230.14},
                    {"location":"North West England","value":230.14},
                    {"location":"South East England","value":230.14},
                    {"location":"London","value":230.14},
                    {"location":"South West England","value":230.14},
                    {"location":"West Midlands","value":230.14},
                    {"location":"Yorkshire and Humber","value":230.14},
                    {"location":"Mid Wales","value":230.14},
                    {"location":"North Wales","value":230.14},
                    {"location":"South East Wales","value":230.14},
                    {"location":"South Wales","value":230.14},
                    {"location":"West Wales","value":230.14},
                    {"location":"Mid East Scotland","value":230.14},
                    {"location":"Mid Scotland","value":230.14},
                    {"location":"Mid West Scotland","value":230.14},
                    {"location":"North Scotland","value":230.14},
                    {"location":"South Scotland","value":230.14}
                ],
                inflation: [
                    {"type":"Care Fee per week","apply":"N"},
                    {"type":"NHS funded nursing care per week","apply":"N"},
                    {"type":"State Pension per week","apply":"N"},
                    {"type":"Othe Benfits per week","apply":"N"},
                    {"type":"Other Weekly Income","apply":"N"},
                    {"type":"Expenditure Per Week","apply":"N"},
                    {"type":"LA Usual Price","apply":"N"},
                    {"type":"Living Cost Contribution","apply":"N"}
                ]
            };


            // Default values
            var defaults = {
                cap: 72000,                 /* Care cap */
                inflationRate: 1.03,        /* Inflation rate to apply to future years */
                tariffRate: 0.004,          /* Inflation rate to apply to future years */
                upperThreshold: 118000,     /* Upper capital threshold */
                lowerThreshold: 17000,      /* Lower capital threshold */
                personalAllowance: 24.40    /* Personal allowance - basic */
            };

            // Initialise form object
            var init = function (options) {             
                this.options = $.extend({}, defaults, options);
                return this;
            };

            var latestData = function () {
                return data[data.length - 1];
            };

            var addData  = function (dataObject) {
                var self = this;
                if (dataObject !== undefined) {
                    this.data.push(dataObject);
                }
                return self;
            };

            var currency = function (value) {
                var m = parseFloat(value);
                return !isNaN(m) ? m.toFixed(2) : 0.00;     ///TODO: could round up to pound
            };

            // Returns a match from table given inputs (like VLOOKUP)
            var getLookup = function (table, inputs) {
                var result;

                switch (table) {

                    case lookups.careHomeData:           
                        result = $.grep(table, function (v) {
                            return ((v.homeType === inputs.homeType) && (v.careType === inputs.careType) && (v.location === inputs.location));
                        });
                        return (result.length > 0) ? result[0].price : null;

                    case lookups.livingCostContribution:           
                        result = $.grep(table, function (v) {
                            return (v.location === inputs.location);
                        });
                        return (result.length > 0) ? result[0].value : null;
                }
            };

            // Specific lookups
            // LA Usual Price; uses careHomeData table
            var laUsualPrice = function () {
                // Use most recent data
                var d = latestData();
                var l = getLookup(lookups.careHomeData, {homeType: d.homeType, careType: d.careType, location: d.location});    
                if (l === null) {
                    return 0;
                }
                else {
                    return (l > d.careFee) ? d.careFee : l;
                }
            };

            // Living cost contribution
            var livingExpenses = function () {
                // Use most recent data
                var d = latestData();
                var l = getLookup(lookups.livingCostContribution, {location: d.location});    
                return (l !== null) ? l : 0;
            };

            // Render json data as a table
            var drawTable = function (data, $selector) {
                // Empty table
                $selector.empty();

                // Draw header
                var r = $("<tr/>");
                $selector.append(r);
                $.each(data[0], function (k) {
                    r.append($("<th>" + k + "</th>"));
                });

                // Draw body
                $.each(data, function (rowIndex, row) {
                    var r = $("<tr/>");
                    $selector.append(r);
                    $.each(row, function (k, v) {
                        r.append($("<td>" + v + "</td>"));
                    });
                });
            };

            // Time and Date Helper Functions
            // Pad numbers with leading zeros to reach size
            var pad = function (num, size) {
                var s = num + "";
                while (s.length < size) { s = "0" + s; }
                return s;
            };

            // Convert a date into a string dd/mm/yyyy
            var formatDate = function (date) {
                if (date !== undefined) {
                    var d = pad(date.getDate(), 2);
                    var m = pad(date.getMonth() + 1, 2);
                    var y = date.getFullYear();
                    return (d + "/" + m + "/" + y);
                }
                else {
                    return "";
                }
            };

            // Convert a string dd/mm/yyyy into date
            var strToDate = function (dateString) {
                if ((dateString !== undefined) && (dateString !== "")) {
                    // Split into day, month and year
                    var d = parseInt(dateString.substr(0, 2));
                    var m = parseInt(dateString.substr(3, 2)) - 1;
                    var y = parseInt(dateString.substr(6, 4));
                    return new Date(y, m, d);
                }
                else {
                    return new Date(1900, 0, 1);
                }
            };

            var formatCapTime = function (days) {
                var now = new Date();
                var end = new Date();
                end.setDate(now.getDate() + days);

                return formatDate(end);
            };

            // Get financial year: no argument === current financial year
            var finYear = function (d) {
                if (d === undefined) { d = new Date(); }
                var m = d.getMonth();
                var y = d.getFullYear();
                var lastTwo = parseInt(y.toString().substr(2, 2));
                var fy = (m <= 2) ? (y - 1) + "/" + lastTwo : y + "/" + (lastTwo + 1);
                return fy;
            };

            // Returns a WEEKLY tariff amount for given capital value
            // value < lower threshold = 0 AND value > upper threshold = 0
            var tariff = function (value) {
                var self = this;
                var amount = parseFloat(value);
                if (isNaN(amount)) {
                    return 0;
                }
                else {
                    amount = (amount >= self.options.upperThreshold) ? 0 : amount;
                    var t = (amount <= self.options.lowerThreshold) ? 0 : parseInt((amount - self.options.lowerThreshold) * self.options.tariffRate + 1);
                    return t;
                }
            };

            var summary = function () {
                // Fee paid
                var ld = latestData();
                var fee = ld.careFee;                           // Total weekly care fees paid
                var laup = laUsualPrice();                      // LA usual price for type of careType  (A)
                var livExp = livingExpenses();                  // Living expenses allowance            (B)       ///TODO: increase if home-owner?
                var careCap = laup - livExp;                    // Weekly cost to customer              (A - B)
                var notCounted = fee - laup;                    // Element not counted                  (fee - B)
                var timeToCap = DP.options.cap / careCap;       // Time to reach cap (weeks)
                var capDate = formatCapTime(timeToCap * 7);     // Date that cap is reached

                return {
                    fee: currency(fee), 
                    laup: currency(laup), 
                    livExp: currency(livExp), 
                    careCap: currency(careCap),
                    notCounted: currency(notCounted),
                    timeToCap: timeToCap,
                    capDate: capDate
                };
            };

            var schedule = function (period, duration) {    ///TODO: missing LA funding items
                var self = this;

                // Set period in days (default is week) 
                // and duration in years (default is 2)
                if (period === undefined) { period = 7; }
                if (duration === undefined) { duration = 2; }

                // Set initial variable values
                var ratio = period / 7,
                    ld = latestData(),
                    d = new Date(),
                    capital = parseFloat(ld.capitalAmount) + parseFloat(ld.propertyValue),
                    income = (parseFloat(ld.statePension) + parseFloat(ld.otherBenefits) + parseFloat(ld.otherIncome) - self.options.personalAllowance) * ratio,
                    s = summary(),
                    laup = (s.laup) * ratio,               ///TODO: apply annual inflation to laup element
                    pLaup = laup,
                    eligible = s.careCap * ratio,
                    cumulativeEligible = 0,
                    careCost = s.fee * ratio,
                    cumulativeCareCost = 0,
                    table = [],
                    capReached = false;

                // Set schedule over duration
                for (var p = 0 ; p < ((duration * 365) / period); p++) {
                    
                    // Increment date
                    d.setDate(d.getDate() + period);

                    // Calculate elements for this period
                    var pTariff  = self.tariff(capital) * ratio;
                    var pTotalIncome = income + pTariff;

                    // Set period laup = total income if laup > total income
                    if ((pTariff > 0) && ((pTotalIncome) < pLaup)) {
                        pLaup = pTotalIncome;
                    }
                    
                    var pTopUp = (capital >= self.options.upperThreshold) ? careCost - laup : 0,
                        pThirdTopUp = (capital >= self.options.upperThreshold) ? 0 : careCost - laup,
                        pTotalClientCost = (capital >= self.options.upperThreshold) ? careCost : pLaup,
                        pCapitalFund = pTotalClientCost - income;

                    // Calculate LA funding
                    // Has the cap been reached?
                    if ((cumulativeEligible + eligible) >= self.options.cap) { capReached = true; }

                    var pCareCapFund = capReached ? eligible : 0;
                    var pLaOtherFund = ((pTopUp === 0) && (pCareCapFund === 0) && (pTotalIncome <= laup)) ? laup - pTotalIncome: 0;

                    // Put values into object
                    var row = {
                        date: formatDate(d),
                        /*fy: finYear(d),*/                 ///TODO: trigger inflation on new FY
                        capital: currency(capital),
                        eligible: currency(eligible),
                        cumulative: currency(cumulativeEligible = cumulativeEligible + eligible),
                        // LA funding
                        LACareCapFund: currency(pCareCapFund),
                        LAOtherFund: currency(pLaOtherFund),
                        LATotalFund: currency(pLaOtherFund + pCareCapFund),

                        tariffincome: currency(pTariff),
                        clientincome: currency(income),
                        totalincome: currency(pTotalIncome),
                        laup: currency(pLaup),
                        topup: currency(pTopUp),

                        clientcost: currency(pTotalClientCost),
                        capitalfund: currency(pCapitalFund),
                        thirdparty: currency(pThirdTopUp),

                        carefee: currency(careCost)
                    };
                    table.push(row);

                    // Reduce the capital
                    if (!capReached) { 
                        capital = capital - pCapitalFund;
                        cumulativeCareCost += careCost;
                    }
                }

                return {table: table, careCost: currency(cumulativeCareCost)};
            };


            // Public methods
            return {
                data: data,
                addData: addData,
                init: init,
                finYear: finYear,
                laUsualPrice: laUsualPrice,
                summary: summary,
                tariff: tariff,
                schedule: schedule,
                drawTable: drawTable
            };

        })();

        // Initialise
        DP.init();

            function calculateCap() {
                //FB.utils.showSpinner();

                // Add data from form
                var formData = {
                    homeType: $("input[name=carehometype]:checked").val(),
                    careType: $("#caretype").val(),
                    location: $("#location").val(),
                    careFee: $("#carecost").val(),
                    nhsNursingFee: $("#nhsnursing").val(),
                    statePension: $("#pension").val(),
                    otherBenefits: $("#benefits").val(),
                    otherIncome: $("#other").val(),
                    capitalAmount: $("#capital").val(),
                    propertyValue: $("#property").val()
                };
                DP.addData(formData);

                // Update summary fields
                var summary = DP.summary();
                $("#carefee").val(summary.fee);
                $("#laup").val(summary.laup);
                $("#livingcosts").val(summary.livExp);
                $("#carecap").val(summary.careCap);
                $("#datecap").val(summary.capDate);

                // Update payment schedule
                var costs = DP.schedule(7, 10);
                DP.drawTable(costs.table, $("table"));
                $("#totalcarefee").val(costs.careCost);

                // Show table
                $("#output-table").removeClass("hide");

                //FB.utils.hideSpinner();
            }

        </script>
    </body>
</html>